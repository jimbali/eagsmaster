<div class="row">
  <div class="col-12 mt-2">
    <h2>Edit quiz</h2>
    <%= form_for @quiz, url: quiz_url(id: @quiz.id) do |f| %>
      <div class="form-group">
        <%= f.label :name, 'Name' %>
        <%= f.text_field :name, class: 'form-control' %>
      </div>
      <div class="form-group">
        <%=
          f.label :code,
                  'ID code (a short code that people can use to find your quiz)'
        %>
        <%= f.text_field :code, class: 'form-control text-uppercase' %>
      </div>
      <div class="form-group">
        <%= f.label :cursor, 'Current question' %>
        <%=
          f.collection_select :cursor,
                              @quiz.questions,
                              :id,
                              :title,
                              { include_blank: true },
                              { class: 'custom-select' }
        %>
      </div>
      <%= f.submit class: 'btn btn-primary' %>
    <% end %>
  </div>
</div>
<div class="row mt-4">
  <div class="col-12">
    <h3>Questions</h3>
    <p id="questions-console">Changes will be autosaved</p>
    <%=
      tag(
        :div, id: 'questions-root',
        'data-quiz-json': @questions_data.to_json,
        'data-base-url': quiz_question_index_url(quiz_id: @quiz.id)
      )
    %>
    <script>
      var autosaveNotification;
      var questionsConsole = document.getElementById('questions-console');
      var questionsContainer = document.getElementById('questions-root');
      var data = JSON.parse(questionsContainer.dataset.quizJson);
      var token = document.querySelector('meta[name="csrf-token"]').content;
      var baseUrl = questionsContainer.dataset.baseUrl;
      var hot = new Handsontable(questionsContainer, {
        data: data,
        rowHeaders: false,
        colHeaders: ['Title', 'Finished answering?'],
        columns: [
          { data: 'title' },
          { data: 'expired', type: 'checkbox' }
        ],
        filters: true,
        dropdownMenu: true,
        licenseKey: 'non-commercial-and-evaluation',
        contextMenu: ['remove_row'],
        afterChange: function (change, source) {
          if (source === 'loadData') {
            return;
          }
          clearTimeout(autosaveNotification);
          row = data[change[0][0]];
          key = change[0][1];
          questionId = row['id'];
          console.log(questionId);
          fetch(
            baseUrl + '/' + questionId,
            {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': token
              },
              body: JSON.stringify(
                { question: { title: row.title, expired: row.expired } }
              )
            }
          )
          .then((response) => {
            return response.json();
          })
          .then((data) => {
            questionsConsole.innerText  = 'Autosaved (' + change.length + ' ' + 'cell' + (change.length > 1 ? 's' : '') + ')';
            autosaveNotification = setTimeout(function() {
              questionsConsole.innerText ='Changes will be autosaved';
            }, 2000);
          });
        },
        beforeRemoveRow: function(index, amount, physicalRows, source) {
          for(var i = 0; i < physicalRows.length; i++) {
            index = physicalRows[i];
            id = data[index].id;
            fetch(
              baseUrl + '/' + id,
              {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRF-Token': token
                }
              }
            )
            .then((response) => {
              questionsConsole.innerText  = 'Autosaved (row deleted)';
              autosaveNotification = setTimeout(function() {
                questionsConsole.innerText ='Changes will be autosaved';
              }, 2000);
            });
          }
        }
      });
    </script>
    <%= form_for(:question, url: quiz_question_index_url(quiz_id: @quiz.id)) do |f| %>
      <%= f.text_field :title %>
      <%= f.submit 'Add question' %>
    <% end %>
  </div>
</div>
<div class="row mt-4">
  <div class="col-12">
    <h3>Answers</h3>
    <p id="quiz-console">Changes will be autosaved</p>
    <%=
      tag(
        :div, id: 'quiz-root',
        'data-progress-json': @progress_data.to_json,
        'data-base-url': quiz_question_index_url(quiz_id: @quiz.id),
        'data-column-headers': @column_headers.to_json,
        'data-column-data': @column_data.to_json,
        'data-update-progress-url': quiz_update_progress_url(quiz_id: @quiz.id)
      )
    %>
    <script>
      var quizConsole = document.getElementById('quiz-console');
      var quizContainer = document.getElementById('quiz-root');
      var data2 = JSON.parse(quizContainer.dataset.progressJson);
      var autosaveNotification2;
      var token = document.querySelector('meta[name="csrf-token"]').content;
      var updateProgressUrl = quizContainer.dataset.updateProgressUrl;
      hot2 = new Handsontable(quizContainer, {
        data: data2,
        rowHeaders: false,
        colHeaders: JSON.parse(quizContainer.dataset.columnHeaders),
        columns: JSON.parse(quizContainer.dataset.columnData),
        filters: true,
        dropdownMenu: true,
        licenseKey: 'non-commercial-and-evaluation',
        contextMenu: ['remove_row'],
        manualColumnResize: true,
        afterChange: function (change, source) {
          if (source === 'loadData') return;

          clearTimeout(autosaveNotification2);

          var row = data2[change[0][0]];

          fetch(
            updateProgressUrl,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': token
              },
              body: JSON.stringify({ row: row })
            }
          )
          .then((response) => {
            return response.json();
          })
          .then((newData) => {
            quizConsole.innerText  = 'Autosaved (' + change.length + ' ' + 'cell' + (change.length > 1 ? 's' : '') + ')';
            autosaveNotification2 = setTimeout(function() {
              quizConsole.innerText ='Changes will be autosaved';
            }, 2000);
            data2 = newData;
            hot2.loadData(newData);
          });
        }
      });
    </script>
    <%=
      form_for(:user,
               url: quiz_add_guest_url(quiz_id: @quiz.id),
               remote: true,
               html: { id: 'add-guest-form' }) do |f|
    %>
      <%= f.text_field :nickname, placeholder: 'Nickname' %>
      <%= f.submit 'Add guest player' %>
    <% end %>
    <script>
      $(document).on('ajax:success', '#add-guest-form', event => {
        data2 = event.detail[0];
        hot2.loadData(data2);
      });
    </script>
    <button id="export-csv" class="btn btn-primary">Export CSV</button>
    <script>
      $(document).ready(function() {
        $("#export-csv").click(function(){
          var exportPlugin = hot2.getPlugin('exportFile');
          exportPlugin.downloadFile('csv', { columnHeaders: true })
        });
      });
    </script>
  </div>
</div>
